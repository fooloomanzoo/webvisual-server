<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-selector/iron-selectable.html">
<link rel="import" href="../bower_components/iron-form-element-behavior/iron-form-element-behavior.html">
<link rel="import" href="../bower_components/paper-ripple/paper-ripple.html">
<link rel="import" href="ws-dropdown.html">
<link rel="import" href="style/form-styles.html">

<dom-module id="ws-dropdown-selector">
  <template strip-whitespace>
  <style is="custom-style" include="form-styles"></style>
  <style>
    :host {
      box-sizing: border-box;
      position: relative;
      display: flex;
      outline-width: 0;
      outline: none;
      letter-spacing: 0.2px;
    }
    :host([position="bottom"]) {
      border-bottom: 1px solid rgba(0,0,0, 0.12);
    }
    :host([position="left"]) {
      border-left: 1px solid rgba(0,0,0, 0.12);
    }
    :host([position="top"]) {
      border-top: 1px solid rgba(0,0,0, 0.12);
    }
    :host([position="right"]) {
      border-right: 1px solid rgba(0,0,0, 0.12);
    }
    :host([no-focusline]) {
      border: none;
    }
    :host([no-focusline]) > .focusline {
      display: none !important;
    }

    .focusline[position="bottom"] {
      height: 2px;
      width: 5%;
      bottom: 0;
      left: 45%;
    }
    .focusline[position="top"] {
      height: 2px;
      width: 5%;
      top: 0;
      left: 45%;
    }
    .focusline[position="left"] {
      width: 2px;
      height: 5%;
      left: 0;
      top: 45%;
    }
    .focusline[position="right"] {
      width: 2px;
      height: 5%;
      right: 0;
      top: 45%;
    }

    :host:focus .focusline[position="bottom"], :host:focus .focusline[position="top"], :host([active]) .focusline[position="bottom"], :host([active]) .focusline[position="top"] {
      visibility: visible;
      width: 100%;
      left: 0;
    }
    :host:focus .focusline[position="left"], :host:focus .focusline[position="right"], :host([active]) .focusline[position="left"], :host([active]) .focusline[position="right"] {
      visibility: visible;
      height: 100%;
      top: 0;
    }

    #label {
      color: currentColor;
      position: relative;
      float: left;
      left: auto;
      top: auto;
    }

    #container.set #label {
      visibility: visible;
      top: 0;
      font-size: 0.75em;
      /*color: var(--primary-color);*/
    }
    #icon {
      padding: 0.5em;
    }
    #arrow {
      margin-left: 0.5em;
    }
    #ripple {
      color: var(--ripple-color, currentColor);
    }
    [hidden] {
      display: none !important;
    }
  </style>
    <paper-ripple id="ripple"></paper-ripple>
    <section class="inputcontainer" on-tap="toggle" float$="[[!hideSelected]]">
      <template is="dom-if" if="[[icon]]">
        <iron-icon id="icon" icon="[[icon]]"></iron-icon>
      </template>
      <template is="dom-if" if="[[!hideSelected]]">
        <input id="selected" hidden$="[[selected]]" value="[[selected]]" tabindex="1">
      </template>
      <template is="dom-if" if="[[label]]">
        <label id="label" for="container">[[label]]</label>
      </template>
      <template is="dom-if" if="[[!hideArrow]]">
        <iron-icon id="arrow" icon="arrow-drop-down"></iron-icon>
      </template>
      <section class="focusline" position$="[[position]]"></section>
    </section>
    <ws-dropdown id="dropdown" position$="[[position]]" horizontal="[[horizontal]]" align="[[align]]" tabindex="2" offset="[[offset]]">
      <content></content>
    </ws-dropdown>

  </template>
  <script>
    Polymer({
      is: 'ws-dropdown-selector',

      behaviors: [
        Polymer.IronFormElementBehavior,
        Polymer.IronSelectableBehavior
      ],

      properties: {
        label: {
          type: String
        },
        icon: {
          type: String
        },
        position: {
          type: String,
          value: 'bottom',
          reflectToAttribute: true
        },
        align: {
          type: String,
          value: 'start'
        },
        horizontal: {
          type: Boolean
        },
        offset: {
          type: Number,
          value: 0
        },
        value: {
          type: String,
          value: '',
          reflectToAttribute: true
        },
        hideSelected: {
          type: Boolean
        },
        hideArrow: {
          type: Boolean
        },
        active: {
          type: Boolean,
          value: false
        }
      },

      hostAttributes: {
        role: 'combobox',
        tabindex: '0'
      },

      listeners: {
        'iron-select': '_onSelect',
        'keyup': '_keyHandler'
      },

      _onSelect: function() {
        this.value = this.selected;
        if (this.value === '') {
          this.$.container.classList.remove('set')
        } else {
          this.$.container.classList.add('set')
        }
        this.fire('select', this.value);
        this.active = false;
        this.$.dropdown.hide();
      },
      show: function() {
        this.active = true;
        this.$.arrow.set('icon', 'arrow-drop-up');
        this.setAttribute('aria-pressed', '');
        this.$.dropdown.show();
      },
      hide: function() {
        this.active = false;
        this.$.arrow.set('icon', 'arrow-drop-down');
        this.setAttribute('aria-pressed', false);
        this.$.dropdown.hide();
      },
      toggle: function() {
        if (this.active === false) {
          this.show();
        }
        else {
          this.hide();
        }
      },
      _keyHandler: function(e) {
        switch (e.which) {
          case 27: this.hide(); break;
          case 13:
          case 32: this.toggle(); break;
          case 38: this.selectPrevious(); break;
          case 40: this.selectNext(); break;
        }
      }
    });
  </script>
</dom-module>
