<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="style/ws-app-style.html"/>
<link rel="import" href="behaviors/container-behavior.html"/>
<link rel="import" href="behaviors/attribute-repeat-animation-behavior.html"/>
<link rel="import" href="../bower_components/iron-a11y-keys-behavior/iron-a11y-keys-behavior.html"/>
<link rel="import" href="../bower_components/iron-resizable-behavior/iron-resizable-behavior.html"/>
<link rel="import" href="../bower_components/neon-animation/neon-animated-pages.html"/>
<link rel="import" href="../bower_components/neon-animation/neon-shared-element-animatable-behavior.html"/>
<link rel="import" href="../bower_components/neon-animation/neon-animation-runner-behavior.html"/>
<link rel="import" href="../bower_components/neon-animation/animations/scale-up-animation.html"/>
<link rel="import" href="../bower_components/neon-animation/animations/fade-in-animation.html"/>
<link rel="import" href="../bower_components/neon-animation/animations/fade-out-animation.html"/>
<link rel="import" href="../bower_components/neon-animation/animations/slide-up-animation.html"/>
<link rel="import" href="../bower_components/neon-animation/animations/hero-animation.html"/>

Polymer.IronA11yKeysBehavior,
Polymer.IronResizableBehavior,
Polymer.NeonSharedElementAnimatableBehavior,
AttributeRepeatAnimationBehavior,
ContainerBehavior

<dom-module id="ws-app">

  <template>
  <style>
  </style>
  <style include="ws-app-style">
    :host {
      font-size: 1em;
      display: flex;
      flex-direction: column;
      height: 100%;
      width: 100%;
      left: 0;
      top: 0;
      position: absolute;
      pointer-events: all !important;
    }
    #toolbarFooter ::content .toolbar-footer {
      border-width: 0;
      border-color: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      box-sizing: border-box;
      padding: 0;
      padding-right: 1px;
      margin: 0;
      z-index: inherit;
      /*height: 0;*/
      position: relative;
    }
    #toolbarFooter ::content .toolbar-footer[opened] {
      /*height: 100%;*/
    }
    #toolbarFooter ::content .toolbar-footer:last-child {
      padding-right: 0;
    }
    #toolbarFooter ::content svg-element {
      background: rgba(255,255,255,0.2);
    }
    #groupingKeysLabelSelector {
      display: flex;
      flex-direction: column;
    }
    #groupingKeysLabelSelector ::content iron-selector.groupingKeySelector {
      display: flex;
      flex-direction: column;
    }
    #groupingKeysLabelSelector ::content iron-selector.groupingKeySelector:not(.foreground) {
      display: none !important;
    }
    #groupingKeysLabelSelector ::content radio-ws-button {
      font-size: 0.9em;
      padding: 0.5em;
    }
    #labelsTabs {
      height: 34px;
      font-size: 0.85em;
			align-self: flex-end;
			margin-left: 24px;
			margin-right: 60px;
    }
    #labelsTabs ::content tab-element.label.iron-selected {
      background: linear-gradient(to top, rgba(255, 255, 255, 0.35), rgba(255, 255, 255, 0.15));
      color: #f1f1f1;
    }
    #labelsTabs ::content tab-element.label:hover:not(.iron-selected) {
      background: linear-gradient(to top, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.04));
    }
    #labelsTabs ::content tab-element.label.iron-selected[dark] {
      background: linear-gradient(to top, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.08));
      color: #A8CCDB;
    }

		#control ws-icon-button.tab-icon {
			display: none !important;
		}
    @media all and (max-width: 520px) {
			#toolbarHeader {
				flex-direction: column;
			}
			#labelsTabs {
				align-self: flex-start;
				display: none !important;
			}
			#labelsTabs.tabs-opened {
				display: inline-block !important;
			}
			#control ws-icon-button.tab-icon {
				display: inline-block !important;
			}
      #panelSelector ::content .panel {
        display: block;
        padding: 0em;
      }
      #toolbarHeader ws-icon-button.menu-icon {
        margin-left: 12px;
      }
      logo-element#logo {
        left: 64px !important;
      }
    }
    @media all and (min-width: 520px) and (max-width: 600px){
      #toolbarHeader ws-icon-button.menu-icon {
        margin-left: 16px;
      }
      logo-element#logo {
        left: 72px !important;
      }
    }
    [hidden] {
      display: none !important;
    }
  </style>

    <!-- TOOLBAR -->
    <section id="toolbar">
      <section id="toolbarHeader">
        <ws-icon-button icon="menu" class="menu-icon" on-tap="toggleDrawer"></ws-icon-button>

				<section id="labelsTabs">
          <iron-selector id="labelSelector" selected="{{currentLabel}}" attr-for-selected="data-label">
            <content select="tab-element.label"></content>
          </iron-selector>
        </section>

        <section id="control">
					<section id="tabsIcon">
						<ws-icon-button icon="more-vert" class="tab-icon" on-tap="toggleTabs"></ws-icon-button>
					</section>
          <ws-icon-button icon="error-outline" class="error control" on-tap="toggleAlarmPanel" hidden$="[[!isExceeding]]"></ws-icon-button>
          <section hidden$="[[!_computeOpened(opened, forceOpened)]]" style="display: flex;">
            <ws-icon-button icon="[[_computeExpandIcon(expanded)]]" class="expand-icon" on-tap="toolbarExpandToggle"></ws-icon-button>
            <ws-icon-button icon="remove" hidden$="[[forceOpened]]" class="toggle-icon control" on-tap="closeToolbar"></ws-icon-button>
          </section>
        </section>
      </section>

      <logo-element id="logo" on-tap="backToIndex"></logo-element>

      <section id="toolbarFooter" expanded$="[[expanded]]">
        <content select=".toolbar-footer"></content>
      </section>
    </section>

    <section id="mainView">
        <!-- Content -->
        <neon-animated-pages id="panelSelector" selected="{{currentLabel}}" attr-for-selected="data-label">
          <content select=".panel"></content>
        </neon-animated-pages>

        <section id="backdrop" on-tap="closeDrawer"></section>
        <section id="dropShadow" class="has-shadow"></section>

      <!-- EXCEEDING -->
      <section id="alarmPanel">
        <section id="alarmHeader" on-tap="toggleAlarmPanel">
          <ws-button class="title"><iron-icon icon="warning" class="left"></iron-icon><section class="content">Alarme</section></ws-button>
        </section>

        <ws-swipeable-container id="exceedingElementsList"
           is-exceeding="{{isExceeding}}"
           notify-parent="{{!noExceedNotify}}"
           no-select-notify
           no-auto-removal-exceeding-elements>
        </ws-swipeable-container>

        <section style="padding: 0em 0.75em 0.75em 0.75em; float: right;"><a href="#" on-click="_clearExceedingElementsFromList">Liste leeren</a></section>
      </section>

      <!-- SIDEMENU -->
      <section id="drawerPanel">
        <ws-button collapse-id="settings" class="sidemenu collapsable" on-tap="toggleCollapse">
          <iron-icon icon="settings" class="left"></iron-icon>
          <section class="content">Einstellungen</section>
          <iron-icon icon="arrow-drop-up" class="right" id="settings"></iron-icon>
        </ws-button>

            <section class="sidemenu indention collapse settings" opened>
              <ws-button collapse-id="grouping" class="sidemenu" on-tap="toggleCollapse">
                <iron-icon icon="reorder" class="left"></iron-icon>
                <section class="content">Gruppierung</section>
                <iron-icon icon="arrow-drop-down" class="right" id="grouping"></iron-icon>
              </ws-button>
              <section id="groupingKeysButtons" class="sidemenu indention collapse grouping">
                <iron-selector id="groupingKeysLabelSelector" selected="[[currentLabel]]" attr-for-selected="data-label" selected-class="foreground">
                  <content select="iron-selector.groupingKeySelector"></content>
                </iron-selector>
              </section>

              <ws-toggle-button class="sidemenu" on-change="toggleDateView"><iron-icon icon="date-range"></iron-icon>Zeit anzeigen</ws-toggle-button>
              <ws-toggle-button class="sidemenu" on-change="toggleWindowDecoration" checked="{{withoutWindow}}"><iron-icon icon="editor:border-style"></iron-icon>Fensterrahmen</ws-toggle-button>
              <ws-toggle-button class="sidemenu" on-change="toggleWindowHeader" checked="{{hideHeader}}"><iron-icon icon="editor:drag-handle"></iron-icon>Fenstertitel</ws-toggle-button>
              <ws-toggle-button class="sidemenu" id="colorschema" on-change="toggleTheme"><iron-icon icon="settings-brightness"></iron-icon>Farbschema</ws-toggle-button>
            </section>

        <ws-button class="sidemenu" on-tap="backToSelectPage">
          <iron-icon icon="assessment" class="left"></iron-icon>
          <section class="content">Konfigurationsauswahl</section>
        </ws-button>

        <ws-button class="sidemenu" on-tap="backToIndex">
          <iron-icon icon="arrow-back" class="left"></iron-icon>
          <section class="content">Index</section>
        </ws-button>

      </section>
    </section>

  </template>

  <script>
    Polymer({
      is: 'ws-app',

      behaviors: [
        Polymer.IronA11yKeysBehavior,
        Polymer.IronResizableBehavior,
        Polymer.NeonSharedElementAnimatableBehavior,
        AttributeRepeatAnimationBehavior,
        ContainerBehavior
      ],

      properties: {
        active: {
          type: Boolean,
          observer: "activeChanged"
        },
        sharedElements: {
          value: function() {
            return {
              'herologo': this.$.logo
            }
          }
        },
        animationConfig: {
          value: function() {
            return {
              'entry': [
                {
                  name: 'hero-animation',
                  id: 'herologo',
                  toPage: this,
                },
                {
                  animatable: this.$.logo,
                  type: 'loading'
                }
              ],
              'exit': [
                {
                  name: 'scale-down-animation',
                  node: this
                }
              ]
            }
          }
        },

        // Attribute for toolbar is opened
        opened: {
          type: Boolean,
          value: false,
          reflectToAttribute: true,
          observer: 'openedChanged'
        },
        forceOpened: {
          type: Boolean,
          observer: 'forceOpenedChanged'
        },
        expanded: {
          type: Boolean,
          value: false,
          reflectToAttribute: true
        },

        currentLabel: {
          type: String,
          observer: "_currentLabelChanged"
        },
        // Element Appearance
        withoutWindow: {
          type: Boolean,
          value: false
        },
        hideHeader: {
          type: Boolean,
          value: false
        },
        dark: {
          type: Boolean,
          value: false
        },
        showDate: {
          type: Boolean,
          value: false
        },
        noGrouping: {
          type: Boolean,
          value: false
        },

        reproductionContainer: {
          type: String,
          value: 'toolbarFooter'
        },

        animatable: {
          type: Boolean,
          reflectToAttribute: true
        },

        repeatedAttributes: {
          type: Array,
          value: function() {
            return ['opened', 'expanded']
          }
        },

        attributeAnimations: {
          type: Object,
          value: function() {
            return {
              'opened': {
                'exit': {
                  name: 'fade-out-animation',
                  timing: {
                    duration: 250
                  }
                }
              }
            };
          }
        },

        isExceeding: {
          type: Boolean,
          value: false,
          observer: '_handleExceeding'
        },

        nativeNotification: {
          type: Boolean,
          value: false,
          observer: 'requestNotificationPermission'
        }
      },

      listeners: {
        'neon-animation-finish': '_onNeonAnimationFinish'
      },

      keyBindings: {
         'left': 'previousPanel', // same as 'space:keydown'
         'right': 'nextPanel',
         'down': 'contractToolbar',
         'up': 'expandToolbar',
         'esc': 'backToSelectPage'
       },

      attached: function() {
        Polymer.dom(this.$.groupingKeysLabelSelector)
               .observeNodes(function(info) {
                 for (var i in info.addedNodes)
                  if (info.addedNodes[i].nodeName === "IRON-SELECTOR")
                    info.addedNodes[i].addEventListener("iron-select", function(e) {
                      this.regroup(e.currentTarget.selected);
                    }.bind(this));
               }.bind(this));
      },

      getAnimatableNodes: function() {
        return this.getEffectiveChildNodes
                     .call(this.$.toolbarFooter)
                     .filter(function(el) {
                       return (el.nodeType === Node.ELEMENT_NODE);
                     });
      },

      // Toolbar Actions
      openedChanged: function() {
        if (this.opened || this.forceOpened) {
          this.opened = true;
          this.$.toolbarFooter.setAttribute('opened', true);
        }
      },
      forceOpenedChanged: function() {
        if (this.opened || this.forceOpened) {
          if (this.opened === false) {
            this.opened = true;
          }
        }
      },
      toolbarExpandToggle: function() {
        if (this.opened || this.forceOpened) {
          if (this.expanded) {
            this.contractToolbar();
          } else {
            this.expandToolbar();
          }
        }
      },
      contractToolbar: function() {
        this.expanded = false;
      },
      expandToolbar: function() {
        if (this.opened || this.forceOpened) {
          this.expanded = true
        } else {
          this.opened = true;
        }
      },
      closeToolbar: function(newLabel, oldLabel) {
        this.clearSelectedElements();
        this.opened = false;
      },
      _onNeonAnimationFinish: function() {
        if (this.opened === false) {
          if (this.$.toolbarFooter.hasAttribute('opened')) {
            this.$.toolbarFooter.removeAttribute('opened');
          }
        }
        this.notifyResize();
      },

      previousPanel: function() {
        this.$.panelSelector.selectPrevious();
      },

      nextPanel: function() {
        this.$.panelSelector.selectNext();
      },

      _computeOpened: function(opened, forceOpened) {
        return opened || forceOpened;
      },
      _computeExpandIcon: function() {
        if (this.expanded)
          return 'expand-less';
        else
          return 'expand-more';
      },

      _handleExceeding: function(value) {
        if(value && !(this.$.alarmPanel.classList.contains("alarm-panel-opened"))) {
          this.openAlarmPanel();
          this.debounce('alarm-notification', this.createAlarmNotification, 750);
        }
        else if (this.$.exceedingElementsList.exceedingElements.length === 0) {
          this.debounce('close-alarm-panel', this.closeAlarmPanel, 1000);
        }
      },
      // app Control
      backToSelectPage: function() {
        this.clearSelectedElements();
        this.fire("clear-selected-elements");
        this.closeDrawer();
        this.closeToolbar();
        PageSelector.select("0");
      },
      backToIndex: function() {
        window.location.pathname = '/index';
      },
      // Panel Control
      _currentLabelChanged: function(newLabel, oldLabel) {
        // this._selectPanel(newLabel, oldLabel);
        this.clearSelectedElements();
        this.fire("clear-selected-elements");
      },
      _selectPanel: function(newLabel, oldLabel) {
        var newpanel = this.queryEffectiveChildren.call(this.$.panelSelector,'[data-label=' + newLabel + ']'),
            newselector = this.queryEffectiveChildren.call(this.$.groupingKeysLabelSelector,'[data-label=' + newLabel + ']');
        var oldpanel = this.queryEffectiveChildren.call(this.$.panelSelector,'[data-label=' + oldLabel + ']'),
            oldselector = this.queryEffectiveChildren.call(this.$.groupingKeysLabelSelector,'[data-label=' + oldLabel + ']');

        if (newselector && newpanel) {
          newselector.style.display = '';
          newselector.classList.add("foreground");
          newpanel.style.display = '';
          newpanel.classList.add("foreground");
        }

        if (this.animatable) {
          if (oldpanel) {
            oldpanel.addEventListener("transitionend", function(e) {
              if (newpanel)
                newpanel.classList.add("selected");
              oldpanel.classList.remove("foreground");
              oldpanel.removeEventListener(e.type, arguments.callee);
            });
            oldpanel.classList.remove("selected");
            if (oldselector)
              oldselector.classList.remove("foreground");
          }
          else if (newpanel) {
            newpanel.classList.add("selected");
          }
        }
        else {
          if (newpanel)
            newpanel.classList.add("selected");
          if (oldpanel) {
            oldpanel.classList.remove("foreground");
            oldpanel.classList.remove("selected");
            if (oldselector)
              oldselector.classList.remove("foreground");
          }
        }
      },
      // Grouping Options
      regroup: function(key) {
        var label = this.currentLabel;
        var panel = this.queryEffectiveChildren('.panel[data-label="'+label+'"]');
        if (panel)
          panel.groupedKey = key;
      },

      _clearExceedingElementsFromList: function() {
        this.$.exceedingElementsList.clearExceedingElements();
        this.closeAlarmPanel();
      },

      requestNotificationPermission: function() {
        // Notifications
        if (!("Notification" in window)) {
          console.warn("This browser does not support desktop notification");
        }
        //  ask the user for permission
        else if (this.notification && Notification.permission !== 'denied') {
          Notification.requestPermission(function (permission) {
            // If the user accepts, let's create a notification
            if (permission === "granted") {
              var notification = new Notification("Notifikationen aktiv", {icon: '../../img/icons/webicon.png', body: '', tag: ''});
            }
          });
        }
      },

      createAlarmNotification: function() {
        if (Notification.permission !== 'denied') {
          var count = this.exceedingElements.length;
          var msg = '';

          var notification = new Notification(count + ' Elemente im Alarmzustand',
            { icon: '../../img/icons/warning.png',
              body: msg,
              tag: msg });
        }
      },

      toggleTheme: function(){
        var elems = document.querySelectorAll('*');
        if(this.dark === true) {
          for (i = 0; i < elems.length; ++i) {
            elems[i].removeAttribute("dark");
          }
          this.set("dark", false);
        }
        else {
          for (i = 0; i < elems.length; ++i) {
            elems[i].setAttribute("dark", '');
          }
          this.set("dark", true);
        }
        this.updateStyles();
      },
      toggleWindowDecoration: function(){
        var elems = document.querySelectorAll('ws-group-card');
        for (i = 0; i < elems.length; ++i) {
          elems[i].toggleAttribute("without-window");
        }
      },
      toggleWindowHeader: function(){
        var elems = document.querySelectorAll('ws-group-card');
        for (i = 0; i < elems.length; ++i) {
          elems[i].toggleAttribute("hide-header");
        }
      },
      toggleDateView: function(){
        var elems = document.querySelectorAll('[updatable]');
        for (i = 0; i < elems.length; ++i) {
          elems[i].toggleAttribute("show-date");
        }
      },
      toggleCollapse: function(e){
        var button = e.currentTarget;
        if (!button.hasAttribute('collapse-id')) {
          return;
        }
        var id = button.getAttribute('collapse-id');
        var collapse = Polymer.dom(this.root).querySelector('section.collapse.'+id);
        var iconbutton = Polymer.dom(button).querySelector('iron-icon.right');
        if (collapse) {
          if (collapse.hasAttribute('opened')) {
            collapse.removeAttribute('opened')
          } else {
            collapse.setAttribute('opened', '');
          }
          if (iconbutton) {
            if (iconbutton.icon === 'arrow-drop-down')
              iconbutton.set('icon','arrow-drop-up');
            else
              iconbutton.set('icon','arrow-drop-down');
          }
        }
      },
      // Panel Control
      openAlarmPanel: function() {
        this.$.alarmPanel.classList.add("alarm-panel-opened");
      },
      closeAlarmPanel: function() {
        this.$.alarmPanel.classList.remove("alarm-panel-opened");
      },
      toggleAlarmPanel: function() {
        this.$.alarmPanel.classList.toggle("alarm-panel-opened");
      },
      toggleDrawer: function(){
        this.$.drawerPanel.classList.toggle("drawer-opened");
        this.$.backdrop.classList.toggle("backdrop-opened");
      },
      closeDrawer: function(){
        this.$.drawerPanel.classList.remove("drawer-opened");
        this.$.backdrop.classList.remove("backdrop-opened");
      },
      toggleTabs: function(){
        this.$.labelsTabs.classList.toggle("tabs-opened");
				this.fire('resize');
      },
      closeTabs: function(){
        this.$.labelsTabs.classList.remove("tabs-opened");
				this.fire('resize');
      },
      activeChanged: function() {
        var preconf = JSON.parse(localStorage.getItem(window.Name));
        if (this.active === true && preconf && preconf.selectedLabels) {
          this.$.panelSelector.select(preconf.selectedLabels[0]);
        }
        this.notifyResize();
      }
    });
  </script>
</dom-module>
