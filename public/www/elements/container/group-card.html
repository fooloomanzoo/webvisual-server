<dom-module id='group-card'>
  <template>
    <style>
      :host {
        display: block;
        position: relative;
        box-sizing: border-box;
        border-radius: 6px;
        -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none;
        -webkit-touch-callout: none; -webkit-tap-highlight-color:rgba(0,0,0,0);
        font-weight: normal;
        background: #f1f1f1;
        border: none;
        border-color: #AAA;
        box-shadow: 0 4px 5px 0 rgba(0, 0, 0, 0.14),
                    0 1px 10px 0 rgba(0, 0, 0, 0.12),
                    0 2px 4px -1px rgba(0, 0, 0, 0.4);
      }
      :host([dark]) {
        background: #959595;
        border-color: #444;
      }
      /*IE needs a fixed width*/
      @media all and (-ms-high-contrast: none), (-ms-high-contrast: active) {
        :host {
          width: calc(50% - 0.8em);
        }
      }
      @media all and (max-width: 520px) {
        :host {
          width: 100%;
          max-width: 100%;
        }
      }
      @media all and (min-width: 521px) and (max-width: 1340px) and (orientation: portrait) {
        :host {
          max-width: calc(50% - 0.8em);
        }
      }
      @media all and (min-width: 1340px) and (max-width: 2000px) and (orientation: portrait) {
        :host {
          max-width: calc(33.33% - 0.8em);
        }
      }
      @media all and (min-width: 521px) and (max-width: 1060px) and (orientation: landscape) {
        :host {
          max-width: calc(50% - 0.8em);
        }
      }
      @media all and (min-width: 1061px) and (max-width: 2000px) and (orientation: landscape) {
        :host {
          max-width: calc(33.33% - 0.8em);
        }
      }
      @media all and (min-width: 2001px) {
        :host {
          max-width: calc(25% - 0.8em);
        }
      }
      #header {
        white-space: normal;
        position: relative;
        box-sizing: border-box;
        border-top-left-radius: inherit;
        border-top-right-radius: inherit;
        overflow: hidden;
        border-bottom-left-radius: 0px;
        border-bottom-right-radius: 0px;
        background: var(--bright-primary-color);
        color: var(--bright-text-color);
        font-size: 1em;
        height: auto;
      }
      :host([dark]) > #header {
        background: var(--dark-primary-color);
        color: var(--highlight-color);
      }
      #background {
        position: absolute;
        left: 0; top: 0; right: 0; bottom: 0;
        background: linear-gradient(to top, rgba(255,255,255,0.05) 30%,rgba(255,255,255,0.25) 90%)
      }
      #title {
        cursor: pointer;
        position: relative;
        height: 100%;
        width: auto;
        font-size: 1.1em;
        padding: 0.6em 0.8em;
        box-sizing: border-box;
        color: white;
        border-top-left-radius: inherit;
        border-top-right-radius: inherit;
        border-bottom-left-radius: 0px;
        border-bottom-right-radius: 0px;
        text-transform: none;
      }
      #title[overlay] {
        position: absolute;
        height: auto;
        width: auto;
        bottom: 0;
        left: 0;
      }
      :host([dark]) #title {
        color: var(--highlight-color);
      }
      #mainContent {
        flex-direction: row;
        display: flex;
        position: relative;
        box-sizing: border-box;
        flex-wrap: wrap;
        align-items: flex-start;
        justify-content: space-around;
        border-top-width: thin;
        border-top-style: solid;
        border-top-color: inherit;
        border-top-left-radius: 0px;
        border-top-right-radius: 0px;
        border-bottom-left-radius: inherit;
        border-bottom-right-radius: inherit;
        padding: 0.4em 0em 0em 0.5em;
        background: none;
        height: auto;
        width: auto;
        overflow: visible;
      }
      #mainContent ::content > * {
        margin: 0 0.5em 0.5em 0;
        border-radius: 12px;
      }
      #headerContent ::content .header {
        display: flex;
        flex: 1;
        position: relative;
      }
      #headerContent[opened] {
        height: calc(15vh + 120px);
        max-height: 40vh;
      }
      svg-element {
        background: none;
        /*height: 0%;*/
      }
      /*svg-element[opened] {
        height: 100%;
      }*/

      #header[hidden] ~ #mainContent {
        border-top-left-radius: inherit;
        border-top-right-radius: inherit;
      }
      :host:not([title]), :host([title='*']), :host([without-window]) {
        background: transparent;
        border-radius: inherit;
        box-shadow: none;
        border-color: transparent;
      }
      :host:not([title]), :host([title='*']) {
        max-width: none;
      }
      :host:not([title]) > #mainContent, :host([title='*']) > #mainContent {
        align-items: center;
        justify-content: flex-start;
      }
      [hidden] {
        display: none !important;
      }
    </style>

      <section id='header' hidden$='[[_hidetitle(title,withoutWindow,hideHeader)]]'>
        <section id="background"></section>

        <!-- <template is="dom-if" if="[[svg.source]]"> -->
        <section id="headerContent" style="display: none;">
          <content select='.header'></content>
          <svg-element id='svgElement' hidden$="[[!svg.source]]" source="[[svg.source]]" initially-zoom-to-selected exceeding-elements="[[exceedingElements]]" open-on-exceed></svg-element>
        </section>
        <!-- </template> -->
        <section id='title' on-tap='toggle'>[[title]]</section>
      </section>

      <section id='mainContent'>
        <content></content>
      </section>

  </template>
  <script>
    GroupCard = Polymer({
      is: 'group-card',

      behaviors: [
        AttributeRepeatAnimationBehavior,
        ContainerBehavior
      ],

      properties: {
        title: {
          type: String,
          value: '',
          reflectToAttribute: true,
          observer: '_titleChanged'
        },
        opened: {
          type: Boolean,
          value: false,
          observer: 'openedChanged',
          reflectToAttribute: true
        },
        placeholder: {
          type: String,
          value: ''
        },
        withoutWindow: {
          type: Boolean,
          value: false,
          reflectToAttribute: true
        },
        hideHeader: {
          type: Boolean,
          value: false,
          reflectToAttribute: true
        },

        notify: {
          type: Boolean,
          value: false
        },
        notifyParent: {
          type: Boolean,
          value: false
        },
        noSelectNotify: {
          type: Boolean,
          value: false
        },
        noExceedNotify: {
          type: Boolean,
          value: false
        },

        openOnSelect: {
          type: Boolean,
          value: false,
          observer: 'sourceChanged'
        },
        openOnExceed: {
          type: Boolean,
          value: false,
          observer: 'sourceChanged'
        },

        reproduce: {
          type: Boolean,
          value: false
        },
        reproductionContainer: {
          type: String,
          value: 'header'
        },

        draggable: {
          type: Boolean,
          value: true
        },
        droppable: {
          type: Boolean,
          value: true
        },

        svg: {
          type: Object,
          value: {},
          observer: 'sourceChanged'
        },

        animatable: {
          type: Boolean,
          value: false
        },
        repeatedAttributes: {
          type: Array,
          value: function() {
            return [ 'opened' ];
          }
        }
      },

      factoryImpl: function(title, svg, dark, withoutWindow, hideHeader) {
        this.set('title', title || '');
        if (dark) {
          this.setAttribute('dark', '');
        }
        if (svg) {
          this.set('svg', svg);
        }
        if (withoutWindow)
          this.swithoutWindow = true;
        if (hideHeader)
          this.hideHeader = true;
      },

      attached: function() {
          this.sourceChanged();
      },

      observers: [
        '_exceedingChanged(exceedingElements.splices)'
      ],

      listeners: {
        'neon-animation-finish': '_onNeonAnimationFinish'
      },

      toggle: function() {
        if (!this.opened) {
          this.open();
        }
        else {
          this.close();
        }
      },

      open: function() {
        if (this.svg && this.svg.source)
          this.opened = true;
        else
          this.opened = false;
      },

      close: function() {
        this.opened = false;
      },

      sourceChanged: function() {
        if (!this._initial) {
          this._initial = {openOnSelect: this.openOnSelect, openOnExceed: this.openOnExceed};
        }
        if (this.svg && this.svg.source) {
          this.openOnSelect = this._initial.openOnSelect;
          this.openOnExceed = this._initial.openOnExceed;
        } else {
          this.opened = false;
          this.openOnSelect = false;
          this.openOnExceed = false;
        }
      },

      openedChanged: function() {
        if (this.opened) {
          this.$.headerContent.style.display = '';
          this.$.title.setAttribute('overlay', '');
        } else {
          this.$.title.removeAttribute('overlay');
        }
      },
      _onNeonAnimationFinish: function() {
        if (!this.opened) {
          this.$.headerContent.style.display = 'none';
          // if (this.$.header.hasAttribute('opened'))
          //   this.$.header.removeAttribute('opened', false);

        }
      },

      _titleChanged: function(title) {
        if (!title) {
          this.title = 'unknown';
          this.$.title.style.color = 'transparent';
          return;
        } else {
          this.$.title.style.color = '';
        }
        this.setAttribute('aria-label', title);
      },

      _hidetitle: function(title, withoutWindow, hideHeader) {
        if (title == '*' || withoutWindow || hideHeader)
          return true;
        else
          return false;
      },

      _exceedingChanged: function(changeRecord) {
        if(this.exceedingElements > 0)
          this.open()
        else
          this.close();
      },

      getAnimatableNodes: function() {
        return [this.$.headerContent, this.$.svgElement];
      }
      // // EXPERIMENTAL RESIZING
      // listeners: {
      //   'iron-resize': 'resized'
      // },
      //
      // resized: function() {
      //   this.debounce('resize', this._resized, 50);
      // },
      //
      // _resized: function() {
      //   if (window.getComputedStyle(this.parentNode, null).getPropertyValue('flex-wrap') === 'wrap') {
      //     var elemscount = this.$.mainContent.children.length;
      //     if (elemscount > 2) {
      //       var paddingoffset = 16, width, tmp, rows;
      //       var elemswidth = d3.max(this.$.mainContent.children, function(c) {
      //         return c.offsetWidth;
      //       });
      //       var elemsheight = d3.max(this.$.mainContent.children, function(c) {
      //         return c.offsetHeight;
      //       });
      //       if (!elemswidth || !elemsheight) return;
      //       tmp = Math.ceil(Math.sqrt(elemscount))*(elemswidth + paddingoffset);
      //       console.log(tmp);
      //       this.style.maxWidth = tmp ? tmp + 'px' : '';
      //
      //       var headerheight = this.$.header.offsetHeight;
      //       var previous = this.previousSibling;
      //
      //       tmp = this.parentNode.offsetWidth - this.offsetLeft;
      //       if (previous && previous.offsetTop === this.offsetTop && previous.offsetHeight > this.offsetHeight) {
      //         rows = Math.floor((previous.offsetHeight - headerheight) / elemsheight);
      //         width = Math.ceil(elemscount / rows) * (elemswidth + paddingoffset);
      //         this.style.maxWidth = (width < tmp) ? width + 'px' : '';
      //       }
      //       var next = this.nextSibling;
      //       if (next && next.offsetTop === this.offsetTop) {
      //         width = next.offsetLeft - this.offsetLeft;
      //         this.style.maxWidth = width + 'px';
      //       }
      //     }
      //   }
      // },

    });
  </script>
</dom-module>
