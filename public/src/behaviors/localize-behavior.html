<!--
modification of PolymerElements/app-localize-behavior for simplification reasons
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<script>

__supportedLanguages = [
  'de',
  'en',
  'fr',
  'es',
  'it',
  'ru',
  'zh'
]

LocalizeBehavior = {

  properties: {

    language: {
      type: String,
      notify: true,
      value: window.navigator.language,
      observer: '_checkLanguage'
    },

    fallbackLanguage: {
      type: String,
      value: 'en'
    },

    /**
     * For example, a valid dictionary would be:
     * this.languageResources = {
     *  'en': { 'greeting': 'Hello!' }, 'fr' : { 'greeting': 'Bonjour!' }
     * }
     */
    languageResources: Object,

    languageResourcePath: String,

    /**
     * Translates a string to the current `language`. Any parameters to the
     * string should be passed in order, as follows:
     * `localize(stringKey, param1Name, param1Value, param2Name, param2Value)`
     */
    localize: {
      type: Function,
      computed: '__computeLocalize(language, languageResources)'
    }
  },

  observers: [
    '_loadLanguageResources(languageResourcePath)'
  ],

  _loadLanguageResources: function(path) {
    var xhr = new XMLHttpRequest();
    xhr.addEventListener('load', function(e) {
      if (e.target.status < 400) {
        console.log(path);
        this.set('languageResources', JSON.parse(e.target.responseText));
        localStorage.setItem('languageResources', e.target.responseText);
      } else {
        var items = localStorage.getItem('languageResources');
        if (items)
          this.set('languageResources', JSON.parse(items));
      }
    }.bind(this));
    xhr.addEventListener('error', function(e) {
      var items = localStorage.getItem('languageResources');
      if (items)
        this.set('languageResources', JSON.parse(items));
    }.bind(this));

    xhr.open('GET', path);
    xhr.send();
  },

  /**
   * Returns a computed `localize` method, based on the current `language`.
   */
  __computeLocalize: function(language, languageResources) {
    var fallback = this.fallbackLanguage;
    console.log('__computeLocalize', language, fallback);
    return function() {
      var fallbackLanguage = fallback;

      if (!arguments[0] || !languageResources || !language)
        return;

      var translatedValue = languageResources[language];

      for (var i = 0; i < arguments.length; i++) {
        if (!translatedValue)
          break;
        translatedValue = translatedValue[arguments[i]];
      }

      // if not present in resources, then use fallbackLanguage
      if (!translatedValue) {
        translatedValue = languageResources[fallbackLanguage];
        for (var i = 0; i < arguments.length; i++) {
          if (!translatedValue)
            break;
          translatedValue = translatedValue[arguments[i]];
        }
      }

      // if not present in resources, then return the (requested) key
      if (!translatedValue) {
        translatedValue = arguments[0];
      }

      return translatedValue;
    };
  },

  _checkLanguage: function(language) {
    if (!language)
      return;
    var lang = language.split('-')[0];
    console.log(lang, language, __supportedLanguages.indexOf(lang), __supportedLanguages);
    if (__supportedLanguages.indexOf(lang) !== -1) {
      this.set('language', lang);
    } else {
      this.set('language', this.fallbackLanguage);
    }
  }
}

</script>
