<script>
  ElementBehavior = {

    properties: {
      item: {
        type: Object,
        observer: '_linkElement'
      },

      values: Array,

      groupedKey: String,

      firstStateChange: {
        type: Array,
        value: function() {
          return [];
        }
      },
      lastStateChange: {
        type: Array,
        value: function() {
          return [];
        }
      },

      exceedable: Boolean,

      isExceeding: {
        type: Boolean,
        value: false
      },

      hasExceeded: {
        type: Boolean,
        value: false
      },

      bubbles: Boolean,

      noSocketConnection: Boolean,

      singleValue: Boolean,

      renderedValue: Object
    },

    observers: [
      '_checkExceeding(isExceeding)',
      'hasExceededChanged(hasExceeded)',
      '_setSocketConnection(noSocketConnection)'
    ],

    get containerRoot() {
      var root = Polymer.dom(this).getOwnerRoot();
      if (!root)
        return Polymer.dom(this).parentNode;
      else if (root.nodeType == Node.DOCUMENT_FRAGMENT_NODE)
        return root.host;
      else {
        return undefined;
      }
    },

    hostAttributes: {
      element: true
    },

    created: function() {
      var sel, uniqueid;
      while (true) {
        uniqueid = String(Math.random().toString(16).slice(2));
        sel = document.querySelector("[uniqueid='" + uniqueid + "']");
        if (!sel) break;
      }
      this.setAttribute('uniqueid', uniqueid);
    },

    factoryImpl: function(obj, properties) {
      this._linkElement(obj, properties);
    },

    detached: function() {
      Webvisual.retractElement(this, this.item);
      this._unlinkElement();
      this.clearValues();
    },

    _linkElement: function(item, olditem) {
      this._unlinkElement(olditem);
      this.clearValues();
      if (item && Object.keys(item).length !== 0) {
        Webvisual.assignElement(this);
      }
    },

    _unlinkElement: function(item) {
      if (item && Object.keys(item).length !== 0) {
        Webvisual.retractElement(this, item);
      }
    },

    getElement: function() {
      return this.properties;
    },

    toDate: function(x) {
      return x ? (this.showFullDate ? new Date(x).toLocaleString() : new Date(x).toLocaleTimeString()) : '';
    },

    getValue: function(y) {
      return this.isIndicatorLamp ? '' : y;
    },

    insertValues: function(values) {
      if (values === undefined) {
        var id = this.item.id
          , system = this.item.system
          , facility = this.item.facility;

        var name = facility + '/' + system + '/' + id;
        if (Webvisual.cache.has(name))
          values = Webvisual.cache.get(name).values;
        else
          values = [];
      }
      if (this.noSocketConnection === true) {
        this.splice('values', this.values.length, 0, values);
      }
      if (this.singleValue === true) {
        if (this.exceedable === true)
          this.checkExceedingState(values[values.length - 1]);
        this.renderInsertedValues(values[values.length - 1]);
      } else {
        if (this.exceedable === true) {
          values.forEach(function (value) {
            this.checkExceedingState(value);
          }, this)
        }
        this.renderInsertedValues(values);
      }
    },

    spliceValues: function(splices) {
      if (splices) {
        if (this.noSocketConnection === true) {
          this.splice('values', 0, splices.length);
        }
        this.renderSplicedValues(splices);
      }
    },

    renderInsertedValues: function(values) {
    },
    renderSplicedValues: function(splices) {
    },

    clearValues: function() {
      this.resetState();
      this.renderedValue = {};
      // if (this.values)
      //   this.renderSplicedValues(this.values);
    },

    checkExceedingState: function(value) {
      if (this.exceedable === false || value === undefined) return;

      if (value.state === 0) {
        if (this.isExceeding === true) {
          this.setLastStateChange(value);
          this.isExceeding = false;
        }
      } else {
        if (this.isExceeding !== true) {
          this.setFirstStateChange(value);
          this.isExceeding = true;
          if (this.hasExceeded === false)
            this.set('hasExceeded', true);
        }
      }
    },

    setFirstStateChange: function(value) {
      this.firstStateChange.push(value);
    },

    setLastStateChange: function(value) {
      this.lastStateChange.push(value);
    },

    _checkExceeding: function(isExceeding, old) {
      if (this.exceedable === true) {
        if (this.bubbles === true) {
          this.dispatchEvent(new CustomEvent('exceeding', {detail: { item: this.item, value: isExceeding }}), {bubbles: true });
        }
      }
    },

    hasExceededChanged: function() {},

    resetState: function() {
      this.isExceeding = false;
      this.hasExceeded = false;
    },

    _setSocketConnection: function(nosocket) {
      // sets a global Object 'Webvisual', for updating the values of the elements
      if (!this.item) {
        return;
      }
      if (!nosocket) {
        try {
          Webvisual.assignElement(this);
          // this.insertValues(this.values || []);
        } catch (e) {
          console.log(this.nodeName, e);
        }
      } else {
        this._unlinkElement(this.item);
      }
    }
  };
</script>
