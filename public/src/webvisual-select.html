<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/neon-animation/neon-shared-element-animatable-behavior.html"/>
<link rel="import" href="../bower_components/neon-animation/neon-animation-runner-behavior.html"/>
<link rel="import" href="../bower_components/neon-animation/animations/scale-up-animation.html"/>
<link rel="import" href="../bower_components/neon-animation/animations/fade-in-animation.html"/>
<link rel="import" href="../bower_components/neon-animation/animations/fade-out-animation.html"/>
<link rel="import" href="../bower_components/neon-animation/animations/slide-up-animation.html"/>
<link rel="import" href="../bower_components/neon-animation/animations/hero-animation.html"/>

<dom-module id="webvisual-page">
  <template>
  <style>
    :host {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: var(--bright-text-color);
    }
    :host([dark]) {
      color: var(--highlight-color);
    }
    #background {
      @apply(--background);
      background: var(--primary-color-background);
      z-index: 200;
    }
    #background([dark]) {
      background: var(--dark-primary-color);
    }
    #mainContent {
      box-sizing: border-box;
      display: block;
      border: none;
      outline: none;
      width: auto;
      height: auto;
      padding: 1.5em;
      z-index: 201;
    }
    .title {
      font-size: 2em;
      line-height: normal;
      margin: 0.5em;
			white-space: normal;
      text-align: center;
    }
    #select {
      font-family: Fira Sans Light;
      font-size: 1em;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: currentColor;
    }
    iron-selector#systemSelector {
      color: currentColor;
    }

    iron-selector#systemSelector ::content radio-button-element  {
      padding: 1em;
    }

    span {
      font-size: 1.2em;
      padding: 1em 1em 0.75em 1em;
    }
    circle-element#loader {
      margin-top: 2.5em;
    }
    button-element#submitButton {
      /*margin-left: auto;*/
      margin-top: 1.5em;
      border-style: solid;
      border-width: thin;
    }
    iron-icon#logo {
      visibility: visible !important;
    }
  </style>

    <section id="background"></section>
    <section id="mainContent">
      <section class="title">Auswahl der Konfiguration</section>
      <section id="select">
        <span>verf√ºgbar sind:</span>
        <iron-selector id="systemSelector" selected-values="[[selectedSystems]]" on-iron-select="_disableButton" on-iron-deselect="_disableButton" multi attr-for-selected="system" selected-attribute="checked">
          <content></content>
        </iron-selector>
        <button-element id="submitButton" disabled raised on-tap="_submit"><iron-icon id="logo" icon="juelich:logo" class="left"></iron-icon>Verbinden</button-element>
        <circle-element id="loader"></circle-element>
      </section>
    </section>

  </template>

  <script>
    Polymer({
      is: 'webvisual-page',

      behaviors: [
        Polymer.NeonSharedElementAnimatableBehavior,
        Polymer.NeonAnimationRunnerBehavior
      ],

      properties: {
        active: {
          type: Boolean,
          value: false,
          observer: "activeChanged"
        },
        selectedSystems: {
          type: Array,
          value: function() {
            return [];
          },
          notify: true
        },
        sharedElements: {
          type: Object,
          value: function() {
            return {
              'herologo': this.$.logo
            }
          }
        },
        animationConfig: {
          value: function() {
            return {
              'entry': [{
                name: 'fade-in-animation',
                node: this.$.background,
                timing: {
                  duration: 1000,
                  delay: 0,
                  easing: 'ease'
                }
              }, {
                name: 'scale-up-animation',
                node: this.$.mainContent,
                timing: {
                  duration: 500,
                  delay: 0,
                  easing: 'ease'
                }
              }],
              'exit': [{
                name: 'hero-animation',
                id: 'herologo',
                fromPage: this,
              }, {
                name: 'slide-up-animation',
                node: this.$.background,
                timing: {
                  duration: 500,
                  delay: 0,
                  easing: 'ease'
                }
              }, {
                name: 'fade-out-animation',
                node: this.$.mainContent,
                timing: {
                  duration: 300,
                  delay: 0,
                  easing: 'linear'
                }
              }]
            }
          }
        }
      },

      start: undefined,

      attached: function() {
        if (window.Systems && window.Systems.length === 1) {
          window.selectedSystems = this.selectedSystems = window.Systems;
          this._setSelected(window.Systems)
            .then(function(res) {
              this._submit(res);
            }.bind(this));
        } else {
          var preconf = JSON.parse(localStorage.getItem(window.Facility));
          if (preconf && preconf.selectedSystems) {
            this._setSelected(preconf.selectedSystems)
              .then(function(res) {
                this.start = setTimeout(function() {
                  this._submit(res);
                }.bind(this), 5000);
              }.bind(this));
          }
        }
      },

      _setSelected: function(systems) {
        return new Promise(function(resolve, reject) {
          var selected = [];
          if (!systems) reject();
          var systemSelector = this.$.systemSelector;
          for (var i in systems) {
            if (Systems.indexOf(systems[i]) !== -1) {
              selected.push(systems[i]);
              systemSelector.select(systems[i]);
            }
          }
          if (selected.length > 0)
            resolve(selected);
          else
            reject();
        }.bind(this))
      },

      _disableButton: function() {
        if (this.selectedSystems.length === 0)
          this.$.submitButton.setAttribute('disabled', '');
        else {
          clearTimeout(this.start);
          this.$.submitButton.removeAttribute('disabled');
        }
      },

      _submit: function(systems) {
        if (this.start) clearTimeout(this.start);
        this.$.loader.play();

        // save the system to LocalStorage
        if (Array.isArray(systems))
          this.set('selectedSystems', systems)

        window.selectedSystems = this.selectedSystems;
        localStorage.setItem(window.Facility, JSON.stringify({
          selectedSystems: this.selectedSystems
        }));

        // connect the datasocket
        window.DataHandler.connect(this.selectedSystems);
      },
      activeChanged: function() {
        // if (!this.active) {
        this.$.loader.cancel();
        // }
      }
    });
  </script>

</dom-module>
