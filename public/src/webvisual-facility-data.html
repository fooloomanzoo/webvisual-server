<link rel="import" href="../bower_components/polymer/polymer.html">

<dom-module id="webvisual-facility-data">

  <script>
  (function() {

    Polymer({

      is: 'webvisual-facility-data',

      properties: {

        facilityName: String,

        systemName: String,

        itemName: String,

        facilities: {
          type: Array,
          notify: true
        },

        facility: {
          type: Object,
          notify: true
        },

        system: {
          type: Object,
          notify: true
        },

        items: {
          type: Array,
          notify: true
        },

        item: {
          type: Object,
          notify: true
        },

        failure: {
          type: Boolean,
          notify: true,
          readOnly: true
        },

        loggedIn: {
          type: Boolean,
          notify: true
        },

        offline: Boolean
      },

      observers: [
        '_computeLoggedIn(offline)',
        '_computeFacilityList(loggedIn)',
        '_computeFacility(facilities, facilityName)',
        '_computeSystem(facility, systemName)',
        '_computeItems(system)',
        '_computeItem(system.items, itemName)'
      ],

      _computeLoggedIn: function(offline) {
        if (!offline) {
          this._testLoggedIn()
              .then( function() {
                this.loggedIn = true;
              }.bind(this))
              .catch( function() {
                this.loggedIn = false
              }.bind(this));
        }
      },

      _computeFacilityList: function(loggedIn) {
        // if (loggedIn) {
          this._fetchFacilityList()
              .then(function(facilities) {
                this.set('facilities', facilities);
                localStorage.setItem('facilities',  JSON.stringify(facilities));
              }.bind(this))
              .catch(function(status) {
                console.log('Server answered ', status);
                var facilities = localStorage.getItem('facilities');
                if (facilities)
                  this.set('facilities', JSON.parse(facilities));
              }.bind(this));
        // }
      },

      _computeFacility: function(facilities, facilityName) {
        if (facilities && facilityName) {
          this._getNamedArrayItem(facilities, facilityName)
              .then(function(facility) {
                this.set('facility', facility);
                localStorage.setItem('facility', JSON.stringify(facility));
              }.bind(this))
              .catch(function(e) {
                console.log(e);
                var facility = localStorage.getItem('facility');
                if (facility)
                  this.set('facility', JSON.parse(facility));
              }.bind(this))
        }
      },

      _computeSystem: function(facility, systemName) {
        // console.log('system', facility, systemName);
        if (facility && facility.systems && systemName) {
          this._getNamedArrayItem(facility.systems, systemName)
              .then(function(system) {
                this.set('system', system);
                localStorage.setItem('system', JSON.stringify(system));
              }.bind(this))
              .catch(function(e) {
                console.log(e);
                var system = localStorage.getItem('system');
                if (system)
                  this.set('system', JSON.parse(system));
              }.bind(this))
        }
      },

      _computeItems: function(system) {
        // console.log('items', system);
        if (system && system.items) {
          this.set('items', system.items);
        } else {
          var items = localStorage.getItem('items');
          if (items)
            this.set('items', JSON.parse(items));
        }
      },

      _computeItem: function(items, id) {
        for (var i = 0, item; item = items[i]; ++i) {
          if (item.id === id) {
            return item;
          }
        }
      },

      _fetchFacilityList: function() {
        return new Promise( function(resolve, reject) {
          var xhr = new XMLHttpRequest();
          xhr.addEventListener('load', function(e) {
            if ( e.target.status >= 400 ) {
              reject(e.target.status);
            }
            else {
              resolve( JSON.parse(e.target.responseText) );
            }
          });
          xhr.addEventListener('error', function(e) {
            reject(e.target.status);
          });
          xhr.open('GET', '/data/facilities.json');
          xhr.withCredentials = true;
          xhr.send();
        })
      },

      _testLoggedIn: function() {
        return new Promise(function (resolve, reject) {
          var xhr = new XMLHttpRequest();
          xhr.addEventListener('load', function(e) {
            if (e.target.status === 200) {
              resolve();
            } else {
              reject(e.target.status);
            }
          }.bind(this));
          xhr.addEventListener('error', function(e) {
            reject(e.target.status);
          }.bind(this));
          xhr.open('GET', '/auth');
          xhr.withCredentials = true;
          xhr.send();
        });
      },

      _getNamedArrayItem: function(arr, name) {
        return new Promise( function(resolve, reject) {
          if (!arr || !name)
            reject('empty');
          for (var i = 0, c; c = arr[i]; ++i) {
            if (c.name === name) {
              resolve(c);
            }
          }
          // reject('not in array\n' + name + '\n' + JSON.stringify(arr));
        });
      },

      refresh: function() {
        if (this.facilityName && this.systemName) {
          // Try at most 3 times to get the items.
          this._computeItems(this.facilityName, this.systemName, 3);
        }
      }

    });

  })();
  </script>

</dom-module>
