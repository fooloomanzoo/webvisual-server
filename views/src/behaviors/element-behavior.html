<script>
  window.WebvisualBehaviors = window.WebvisualBehaviors || {};

  /**
   * Behavior that adds functionality to assign to socket and adds exceed events
   *
   * @polymerBehavior
   */

  WebvisualBehaviors.ElementBehavior = {

    properties: {

      item: Object,

      values: Array,

      isExceeding: {
        type: Boolean,
        value: false
      },

      hasExceeded: {
        type: Boolean,
        value: false
      },

      bubbles: Boolean,

      storeInside: Boolean,

      viewLength: Number,

      title: {
        type: String,
        reflectToAttribute: true,
        computed: '_computeTitle(item.id)'
      },

      uniqueid: {
        type: String,
        reflectToAttribute: true
      }

    },

    // communication count to webworker
    _messageCount: 0,

    observers: [
      '_exceedingChanged(isExceeding)',
      '_hasExceededChanged(hasExceeded)',
      '_linkElement(item.mount, uniqueid)'
    ],

    hostAttributes: {
      element: true
    },

    ready: function() {
      var sel, uniqueid;
      while (true) {
        uniqueid = String(Math.random().toString(16).slice(2));
        sel = document.querySelector("[uniqueid='" + uniqueid + "']");
        if (!sel) break;
      }
      this.set('uniqueid', uniqueid);
    },

    factoryImpl: function(obj, properties) {
      this._linkElement(obj, properties);
    },

    detached: function() {
      this._unlinkElement();
      this.clearValues();
    },

    _linkElement: function(mount, uniqueid) {
      if (!(mount && uniqueid)) {
        return;
      }
      if (this._olditem) {
        this._unlinkElement(this._olditem);
      }
      this._olditem = this.item;
      this.clearValues();
      if (window.Webvisual && window.Webvisual.assignElement && this.item && this.item.mount) {
        window.Webvisual.assignElement(this);
      }

      this.requestLastValue()
          .then( function(values) {
            this.insertValues(values);
          }.bind(this))
          .catch( function(err) {
            console.log(err);
          } );
    },

    _unlinkElement: function(item) {
      if (window.Webvisual && Webvisual.retractElement && item && item.mount) {
        window.Webvisual.retractElement(this, item);
      }
    },

    getElement: function() {
      return this.properties;
    },

    computeDate: function(x) {
      return x ? (this.showFullDate ? new Date(x).toLocaleString() : new Date(x).toLocaleTimeString()) : '';
    },

    computeValue: function(y) {
      return (this.item && this.item.isIndicatorLamp) ? '' : y;
    },

    insertValues: function(values, len) {
      if (values === undefined) {
        return;
      }

      var len = len || this.viewLength;

      if (!this._initialized)
        this._initialized = true;

      if (values.length <= len) {
        var tmp = values.slice(values.length - len, values.length);
        if (this.item && this.item.exceedable === true) {
          tmp.forEach(function (value) {
            this.checkExceedingState(value);
          }, this)
        }
        if (this.storeInside) {
          this.values = this.values.concat(tmp);
        }
        this.renderInsertedValues(tmp);
        tmp.length = 0;
      } else {
        if (this.item && this.item.exceedable === true) {
          values.forEach(function (value) {
            this.checkExceedingState(value);
          }, this)
        }
        if (this.storeInside) {
          this.values = this.values.concat(values);
        }
        this.renderInsertedValues(values);
      }
      values.length = 0;
    },

    spliceValues: function(splices) {
      if (splices) {
        if (this.storeInside === true) {
          this.splice('values', 0, splices.length);
        }
        if (this.renderSplicedValues) {
          this.renderSplicedValues(splices);
        }
      }
    },

    requestLastValue: function(len) {

      this._messageCount++;
      len = len || this.viewLength || 1;
      var messageId = 'requestLastValue' + this.uniqueid + this._messageCount;
      var req = {
        request: {
          messageId: messageId,
          requestLast: {
            mounts: [this.item.mount],
            length: len || 1
          }
        }
      };

      var uniqueid = this.uniqueid;
      if (window.Webvisual) {
        return new Promise(function(resolve, reject) {

          if (!this.webworker) {
            reject('No webworker in webvisual-client active');
          }

          this.webworker.addEventListener('message', function onMessage(e) {
            if (e.data
             && e.data.messageId
             && e.data.messageId === messageId) {
               this.webworker.removeEventListener('message', onMessage, false );
               resolve(e.data.values);
             }
          }.bind(this), false );

          this.webworker.postMessage( req );
        }.bind(window.Webvisual))
      } else {
        return new Promise( function(resolve, reject) {
          if (this.values)
           resolve(this.values.slice(this.values.length - len, this.values.length))
          else {
            reject();
          }
        }.bind(this));
      }
    },

    requestRange: function(key) {
      var mount = this.mount;
      var uniqueid = this.uniqueid;
      _messageCount = this._messageCount++;
      if (window.Webvisual && window.Webvisual.webworker) {
        return new Promise(function(resolve, reject) {

          var messageId = 'requestRange' + uniqueId + _messageCount;
          this.webworker.addEventListener('message', function onMessage(e) {
            if (e.data
             && e.data.messageId
             && e.data.messageId === messageId) {
               this.webworker.removeEventListener('message', onMessage);
               resolve(e.data.values);
             }
          }.bind(this));

          this.webworker.postMessage(
            {
              request: {
                messageId: messageId,
                rangedValues: {
                  mounts: [mount],
                  key: key
                }
              }
            });
        }.bind(window.Webvisual))
      } else {
        return new Promise( function(resolve, reject) {
          if (this.values)
            resolve([this.min(key), this.max(key)])
          else {
            reject('no values set');
          }
        }.bind(this));
      }
    },

	  min: function(key) { // inspired by d3.array
			var i = -1,
		      a,
		      b;
			var n = this.values.length;

			while (++i < n) if ((b = this.values[i][key]) !== null && b >= b) { a = b; break; }
			while (++i < n) if ((b = this.values[i][key]) !== null && a > b) a = b;

	    return a;
	  },

    max: function(key) { // inspired by d3.array
			var i = -1,
		      a,
		      b;
			var n = this.values.length;

			while (++i < n) if ((b = this.values[i][key]) !== null && b >= b) { a = b; break; }
			while (++i < n) if ((b = this.values[i][key]) !== null && a < b) { a = b; }

	    return a;
	  },

    renderInsertedValues: function(values) {
    },

    clearValues: function() {
      this.resetState();
      this.values = [];
      this.lastValue = {};
      // if (this.values)
      //   this.renderSplicedValues(this.values);
    },

    checkExceedingState: function(value) {
      if (!this.item || this.item.exceedable === false || value === undefined) return;

      if (value.state === 0) {
        if (this.isExceeding === true) {
          this.isExceeding = false;
        }
      } else {
        if (this.isExceeding !== true) {
          this.isExceeding = true;
          if (this.hasExceeded === false)
            this.set('hasExceeded', true);
        }
      }
    },

    _exceedingChanged: function(isExceeding, old) {
      if (this.item && this.item.exceedable === true) {
        if (this.bubbles === true) {
          this.dispatchEvent(new CustomEvent('exceeding', {detail: { item: this.item, value: isExceeding }}), {bubbles: true });
        }
      }
    },

    _hasExceededChanged: function() {},

    resetState: function() {
      this.isExceeding = false;
      this.hasExceeded = false;
    },

    _computeTitle: function(id) {
      return id;
    }
  };
</script>
