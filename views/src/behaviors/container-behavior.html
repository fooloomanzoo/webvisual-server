<script>
  window.WebvisualBehaviors = window.WebvisualBehaviors || {};

  /**
   * Behavior that listens for select and exceed Events
   *
   * @polymerBehavior
   */

  WebvisualBehaviors.ContainerBehavior = {

    properties: {

      opened: Boolean,

      openOnSelect: Boolean,

      openOnExceed: Boolean,

      forceOpened: Boolean,

      isExceeding: Boolean,

      selectNotify: Boolean,

      exceedNotify: Boolean,

      selectEvent: {
        type: String,
        value: 'item-select'
      },

      exceedEvent: {
        type: String,
        value: 'exceeding'
      },

      multi: Boolean,

      noAutoRemovalExceedings: Boolean,

      item: {
        type: Object,
        value: function() {
          return {};
        },
        notify: true
      },

      items: {
        type: Array,
        value: function() {
          return [];
        },
        notify: true
      },

      exceeding: {
        type: Array,
        value: function() {
          return [];
        },
        notify: true
      },
    },

    observers: [
      '_watchSelect(openOnSelect)',
      '_watchExceed(openOnExceed)',
      '_watchSelect(selectNotify)',
      '_watchExceed(exceedNotify)'
    ],

    hostAttributes: {
      container: true
    },

    detached: function() {
      this._watchSelect();
      this._watchExceed();
    },

    _watchSelect: function(selectNotify) {
      if (selectNotify === true) {
        this.listen(this, this.selectEvent, '_select');
        this.listen(this, 'clear-selected-items', 'clearItems');
      } else {
        this.unlisten(this, this.selectEvent, '_select');
        this.unlisten(this, 'clear-selected-items', 'clearItems');
      }
    },

    _watchExceed: function(exceedNotify) {
      if (exceedNotify === true) {
        this.listen(this, this.exceedEvent, '_setExceeding');
        this.listen(this, 'clear-exceeding-items', 'clearExceedings');
      } else {
        this.unlisten(this, this.exceedEvent, '_setExceeding');
        this.unlisten(this, 'clear-exceeding-items', 'clearExceedings');
      }
    },

    _select: function(e) {
      if (e && e.detail && e.detail.item) {
        if (e.detail.value === true)
          this.select(e.detail.item);
        else
          this.deselect(e.detail.item);
      }
    },

    select: function(item) {
      this.set('item', item); // store nevertheless the multi option the last selected Element
      if (this.multi === true) {
        if (this.items.indexOf(item) === -1) {
          this.push('items', item);
        }
      }

      this.opened = this.forceOpened || this.openOnSelect;
    },

    deselect: function(item) {
      if (this.multi) {
        var pos = this.items.indexOf(item);
        if (pos !== -1) {
          this.splice('items', pos, 1);
        }
        this.set('item', (this.items.length !== 0) ? this.items[0] : null);
      } else {
        this.set('item', null);
      }

      this.opened = this.forceOpened || (this.openOnSelect && this.item) ? true : false;
    },

    clearItems: function() {
      this.set('item', null);
      this.splice('items', 0, this.items.length);
    },

    _setExceeding: function(e) {
      if (e && e.detail && e.detail.item) {
        if (e.detail.value === true)
          this.setExceeding(e.detail.item);
        else
          this.unsetExceeding(e.detail.item);
      }
    },

    setExceeding: function(item) {
      var pos = this.exceeding.indexOf(item);
      if (pos === -1)
        this.push('exceeding', item);

      this.isExceeding = (this.exceeding.length > 0) ? true : false;
      this.opened = this.opened || this.forceOpened || (this.openOnExceed && this.isExceeding);
    },

    unsetExceeding: function(item) {
      if (this.noAutoRemovalExceedings === true) return;
      var pos = this.exceeding.indexOf(item);
      if (pos !== -1)
        this.splice('exceeding', pos, 1);

      this.isExceeding = (this.exceeding.length > 0) ? true : false;
      this.opened = this.opened || this.forceOpened || (this.openOnExceed && this.isExceeding);
    },

    clearExceedings: function() {
      this.splice('exceeding', 0, this.exceeding.length);
      this.isExceeding = false;
    },

    _handleExceeding: function(value) {}

  };
</script>
