<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">

<link rel="import" href="behaviors/container-behavior.html">

<link rel="import" href="components/webvisual-icon-button.html">

<link rel="import" href="webvisual-element-svg.html">
<link rel="import" href="webvisual-element-chart.html">
<link rel="import" href="webvisual-table-group.html">

<dom-module id='webvisual-groupcard'>
  <template strip-whitespace>
    <style>
      :host {
        display: block;
        position: relative;
        -webkit-touch-callout: none; -webkit-tap-highlight-color:rgba(0,0,0,0);
        background-color: var(--groupcard-background, #e5e5e5);
      }
      #header {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        display: inline-flex;
        flex-direction: column;
        box-sizing: border-box;
        border-color: inherit;
        height: auto;
        perspective: calc(15vh + 120px);
        perspective-origin: center top;
        isolation: isolate;
      }
      :host(.fullscreen) #header {
        /* blink mistake */
        isolation: unset;
      }
      #title {
        position: absolute;
        -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none;
        top: 0; bottom: 0; left: 0; right: 0;
        padding-top: 0;
        height: 3em;
        width: 100%;
        border-top-left-radius: inherit;
        border-top-right-radius: inherit;
        border-bottom-style: solid;
        border-bottom-width: thin;
        border-color: inherit;
        color: var(--groupcard-header-color, var(--bright-text-color));
        will-change: padding-top;
        transition: padding-top 500ms cubic-bezier(0.6, 0, 0.2, 1);
      }
      #title .title-text {
        margin-left: 1em;
        font-size: 1.1em;
        line-height: normal;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        cursor: pointer;
        mix-blend-mode: exclusion;
      }
      #titleContent {
        position: absolute;
        pointer-events: none;
        top: 0; left: 0; right: 0;
        height: 3em;
        width: 100%;
        display: inline-flex;
        align-items: center;
        justify-content: space-between;
      }
      #titleContent > * {
        pointer-events: all;
      }
      #mainContent {
        display: flex;
        pointer-events: none;
        flex-direction: row;
        border-radius: inherit;
        position: relative;
        box-sizing: border-box;
        flex-wrap: wrap;
        align-items: flex-start;
        justify-content: flex-start;
        padding-left: 0.4em;
        will-change: padding-top;
        transition: padding-top 500ms cubic-bezier(0.6, 0, 0.2, 1);
      }
      #mainContent ::content > * {
        margin: 0 0.5em 0.5em 0;
        pointer-events: auto;
      }
      :host(:not([opened])) #mainContent {
        padding-top: 3.4em;
      }

      #title::before {
        position: absolute;
        content: '';
        left: 0; top: 0; right: 0; bottom: 0;
        border-top-left-radius: inherit;
        border-top-right-radius: inherit;
        pointer-events: none;
        background: linear-gradient(to top, rgba(255,255,255,0.01) 38%,rgba(255,255,255,0.2) 100%);
      }
      #title {
        background-color: var(--groupcard-header-background, var(--bright-primary-color));
      }
      :host([opened]) #mainContent {
        padding-top: calc(15vh + 120px + 0.4em);
      }
      :host([opened]) #title {
        padding-top: calc(15vh + 120px - 3em);
      }
      :host([plain]) {
        border-color: transparent;
        background-color: transparent;
      }
      :host([plain]) #title,
      :host([plain]) #title::before {
        background: transparent;
      }
      :host([plain]) #title {
        border-color: currentColor;
      }

      #headerContent {
        height: calc(15vh + 120px);
        width: 100%;
        position: relative;
        box-sizing: border-box;
        transform-origin: top center;
        transform: rotateX(90deg) scale(0.5);
        transition: transform 500ms cubic-bezier(0.6, 0, 0.2, 1);
      }

      #headerContent > * {
        overflow: hidden;
      }

      webvisual-icon-button {
        opacity: 0.5;
        border-radius: 0;
        mix-blend-mode: exclusion;
        will-change: opacity;
        transition: opacity 150ms cubic-bezier(0.6, 0, 0.2, 1);
      }
      webvisual-icon-button:hover {
        opacity: 1;
      }
      webvisual-icon-button.iron-selected {
        /*opacity: 1;*/
        background-color: rgba(255,255,255, 0.25);
      }
      #title .expand-button {
        margin-right: 0.5em;
        flex-shrink: 0;
      }
      #titleContent:hover .expand-button {
        opacity: 1;
      }
      #select {
        position: absolute;
        visibility: hidden;
        pointer-events: visible;
        -webkit-overflow-scrolling: touch;
        display: inline-block;
        left: 4px; bottom: 0;
        box-sizing: border-box;
        transition: visibility 300ms cubic-bezier(0.6, 0, 0.2, 1);
      }
      :host([opened]) #select {
        visibility: visible;
      }
      [hidden] {
        display: none !important;
      }
      webvisual-element-svg {
        height: 100%;
        width: 100%;
      }
      webvisual-table-group[opened] {
        padding: 3em 0 2.5em 0;
        height: 100%;
        width: 100%;
        box-sizing: border-box;
      }
      webvisual-element-chart[opened] {
        height: calc(100% - 3em);
        width: 100%;
        margin-top: 3em;
        box-sizing: border-box;
      }
    </style>

    <section id='title'>

      <section id='header'>
        <iron-pages id="headerContent" selected="[[view]]" selectable=".view" selected-attribute="opened" on-transitionend="_transitionEnd">
          <template is="dom-if" if="[[_lazyRenderSvg]]">
            <webvisual-element-svg class="view"
              url-prefix="[[svgUrlPrefix]]"
              src="[[svgSrcPath]]"
              multi
              selectable-items="[[svgSelectable]]"
              items="[[items]]"
              exceeding="[[exceeding]]"></webvisual-element-svg>
          </template>
          <template is="dom-if" if="[[_shouldRenderExtensions]]">
            <webvisual-element-chart class="view"
              multi
              items="[[items]]"></webvisual-element-chart>
            <webvisual-table-group class="view"
              items="[[items]]"></webvisual-table-group>
          </template>
        </iron-pages>

        <section id='titleContent'>
          <span class="title-text" on-tap="toggle">[[title]]</span>

          <webvisual-icon-button title="expand" on-tap="toggle" class="expand-button" icon="[[expandIcon]]"></webvisual-icon-button>
        </section>

        <template is="dom-if" if="[[opened]]">
          <iron-selector id="select" selected="{{view}}" selectable=".button">
            <template is="dom-if" if="[[svgSrcPath]]">
              <webvisual-icon-button title="map" icon="map" class="button"></webvisual-icon-button>
            </template>
            <template is="dom-if" if="[[_shouldRenderExtensions]]">
              <webvisual-icon-button title="chart" icon="show-chart" class="button"></webvisual-icon-button>
              <webvisual-icon-button title="table" icon="list" class="button"></webvisual-icon-button>
            </template>
          </iron-selector>
        </template>
      </section>

    </section>

    <section id="mainContent">
      <content></content>
    </section>


  </template>

  <script>
    WebvisualGroupCard = Polymer({

      is: 'webvisual-groupcard',

      behaviors: [
        WebvisualBehaviors.ContainerBehavior
      ],

      properties: {

        title: {
          type: String,
          value: '',
          reflectToAttribute: true,
          observer: '_titleChanged'
        },

        opened: {
          type: Boolean,
          reflectToAttribute: true,
          observer: '_openedChanged'
        },

        expandIcon: {
          type: String,
          value: 'unfold-more',
          computed: '_computeExpandIcon(opened)'
        },

        svgUrlPrefix: String,

        svgSrcPath: String,

        svgSelectable: Object,

        view: Number,

        _shouldRenderExtensions: {
          type: Boolean,
          computed: '_computeShouldRenderExtensions(items.length)'
        },

        _lazyRenderSvg: {
          computed: '_computeLazyRenderSvg(opened, svgSrcPath)'
        }

      },

      toggle: function() {
        if (!this.opened) {
          this.opened = true;
        }
        else {
            this.opened = false;
        }
      },

      open: function() {
        this.opened = true;
      },

      close: function() {
        this.opened = false;
      },

      _openedChanged: function(opened, old) {
        if (old === undefined) {
          this.view = 0;
        }
        requestAnimationFrame( function() {
          if (opened) {
            this.$.headerContent.style.cssText = 'will-change: transform; transform: rotateX(0deg) scale(1);';
            if (this.$.headerContent.selectedItem) {
              this.$.headerContent.selectedItem.style.display = '';
            }
          } else {
            this.$.headerContent.style.cssText = 'will-change: transform; transform: rotateX(90deg) scale(0.5);';
          }
        }.bind(this));
      },

      _transitionEnd: function() {
        requestAnimationFrame( function() {
          if (!this.opened) {
            if (this.$.headerContent.selectedItem) {
              this.$.headerContent.selectedItem.style.display = 'none';
            }
          } else {
            this.$.headerContent.style['will-change'] = '';
            if (this.$.headerContent.selectedItem && this.$.headerContent.selectedItem.notifyResize) {
              this.$.headerContent.selectedItem.notifyResize();
            }
          }
        }.bind(this));
      },

      _titleChanged: function(title) {
        this.setAttribute('aria-system', title);
      },

      _computeExpandIcon: function(opened) {
        return opened ? 'unfold-less' : 'unfold-more';
      },

			_computeShouldRenderExtensions: function(length) {
			  return length > 0;
			},

      _computeLazyRenderSvg: function(opened, svgSrcPath) {
        return opened && Boolean(svgSrcPath);
      }

    });
  </script>
</dom-module>
