<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../mixins/fetch-mixin.html" />

<dom-module id="group-data">

  <script>
    class GroupData extends WebvisualMixins.FetchMixin(Polymer.Element) {

      static get is() {
        return 'group-data'
      }

      static get properties() {
        return {

          urlPrefix: {
            type: String,
            value: '/data/'
          },

          loggedIn: {
            type: Boolean
          },

          room: {
            type: String
          },

          groupedKey: {
            type: String,
            notify: true,
            observer: '_groupedKeyChanged'
          },

          groupingKeys: {
            type: Array,
            value: function() {
              return [];
            },
            notify: true,
            observer: '_groupingKeysChanged'
          },

          groups: {
            type: Array,
            value: function() {
              return [];
            },
            notify: true
          },

          subgroups: {
            type: Array,
            computed: '_computeSubGroups(groups, groupedKey)',
            notify: true
          }

        }
      }

      static get observers() {
        return [
          '_fetchGroups(room, loggedIn)'
        ]
      }

      _fetchGroups(room) {
        if (!room) return;

        const names = room.split('/')
          .filter(function(str) {
            return str !== '';
          });
        if (names.length === 2) {
          this.roomUri = names[0] + '+' + names[1];
          Promise.all([
            this._fetch(this.roomUri + '+groups.json', 'GET', 'include', 'json', 'groups'),
            this._fetch(this.roomUri + '+groupingKeys.json', 'GET', 'include', 'json', 'groupingKeys')])
            .catch(err => {
              console.log(err);
            });
        } else {
          this.dispatchEvent(new CustomEvent('data-error', {
            bubbles: true,
            composed: true,
            detail: 'Room is not defined'
          }));
        }
      }

      _computeSubGroups(groups, groupedKey) {
        if (!(groups === undefined && groupedKey === undefined)) {
          let group;
          for (let i = 0; (group = groups[i]); ++i) {
            if (group.key === groupedKey) {
              return group.groups;
            }
          }
        }
        return [];
      }

      _groupingKeysChanged(groupingKeys) {
        if (!(groupingKeys && groupingKeys.length)) {
          return;
        }
        const groupedKey = localStorage.getItem('groupedKey');
        setTimeout(() => {
          if (groupedKey !== undefined && groupingKeys.indexOf(groupedKey) !== -1) {
            this.set('groupedKey', groupedKey);
          } else if (this.roomUri) {
            this._fetch(this.roomUri + '+preferedGroupingKey.json', 'GET', 'include', 'json', 'groupedKey', true)
              .catch(err => {
                console.log(err);
              });
          }
        }, 0);
      }

      _groupedKeyChanged(groupedKey) {
        if (groupedKey !== undefined) {
          localStorage.setItem('groupedKey', groupedKey);
        }
      }
    }
    customElements.define(GroupData.is, GroupData);
  </script>

</dom-module>
