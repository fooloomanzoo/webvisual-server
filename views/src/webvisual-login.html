<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-ripple/paper-ripple.html">

<link rel="import" href="behaviors/localize-behavior.html">

<link rel="import" href="style/shared-styles.html">
<link rel="import" href="style/webvisual-button.html">
<link rel="import" href="style/webvisual-input.html">

<dom-module id="webvisual-login">

  <template>

    <style include="shared-styles webvisual-input webvisual-button">
      :host {
        display: -ms-flexbox;
        display: -webkit-flex;
        display: flex;
        -ms-flex-align: center;
        -webkit-align-items: center;
        align-items: center;
        -ms-flex-pack: center;
        -webkit-justify-content: center;
        justify-content: center;
        -ms-flex-direction: column;
        -webkit-flex-direction: column;
        flex-direction: column;
        min-height: 100vh;
        box-sizing: border-box;
        outline: none;
      }
      .box {
        background: #f1f1f1;
        box-shadow: 0px 2px 6px 4px rgba(0,0,0,0.16);
        color: black;
        border-radius: 32px;
        position: relative;
        box-sizing: border-box;
        font-size: 1em;
        padding: 1.5em;
        margin: 2em;
        white-space: normal;
        line-height: 1.4;
      }
      #login {
        display: -ms-flexbox;
        display: -webkit-flex;
        display: flex;
        -ms-flex-align: center;
        -webkit-align-items: center;
        align-items: center;
        -ms-flex-pack: center;
        -webkit-justify-content: center;
        justify-content: center;
        -ms-flex-direction: column;
        -webkit-flex-direction: column;
        flex-direction: column;
        position: relative;
        box-sizing: border-box;
        font-size: 1em;
        padding: 1.5em;
        margin: auto;
        align-self: center;
        white-space: normal;
        line-height: 1.4;
      }

      #login > * {
        margin-bottom: 1em;
      }

      h1, h4 {
        font-weight: normal;
        text-align: center;
        white-space: normal;
      }
      #loginInfo {
        font-size: 1.1em;
        margin: 0;
        margin-bottom: 1.5em;
      }
      .input-box {
        display: inline-flex;
        align-items: center;
      }
      .left {
        margin-right: 0.75em;
      }
      .right {
        margin-left: 0.75em;
      }
      #loginbutton {
        width: 100%;
        border-radius: 12px;
        padding: 0;
        pointer-events: none;
        border: thin solid currentColor;
      }
      #loginbutton > button {
        padding: 1em;
        pointer-events: all;
      }
      button > span {
        padding: 0.5em;
      }

    </style>

    <div class="box">

      <header>
        <h1>Webvisual</h1>
      </header>

      <form id="login"
        action="/login"
        method="post">

        <h4 id="loginInfo">{{localize('login', 'title')}}</h4>

        <section class="input-box">
          <iron-icon class="left" icon="perm-identity"></iron-icon>
          <webvisual-input>
            <input id="username" type="text" name="username" placeholder$="{{localize('login', 'username')}}(@fz-juelich.de)" autofocus required tabindex="1"
            aria-labelledby="usernameLabel loginInfo" autocomplete="username"/>
            <webvisual-md-decorator error-message="Invalid Username" aria-hidden="true">
              <label id="usernameLabel">{{localize('login', 'username')}}</label>
              <webvisual-underline></webvisual-underline>
            </webvisual-md-decorator>
          </webvisual-input>
        </section>

        <section class="input-box">
          <iron-icon class="left" icon="more-horiz"></iron-icon>
          <webvisual-input>
            <input id="password" class="input" type="password" name="password" placeholder="{{localize('login', 'password')}}" required tabindex="2" autocomplete="password"
            aria-labelledby="passwordLabel loginInfo" autocomplete="password" />
            <webvisual-md-decorator error-message="Invalid Password" aria-hidden="true">
              <label id="passwordLabel">{{localize('login', 'password')}}</label>
              <webvisual-underline></webvisual-underline>
            </webvisual-md-decorator>
            <input id="csrf_token" hidden type="hidden" name="csrf_token" value="{{csrf_token}}" />
          </webvisual-input>
        </section>

        <webvisual-button id="loginbutton" on-tap="_onSignIn">
          <paper-ripple></paper-ripple>
          <button type="submit" name="button" class="button">
            <iron-icon class="left" icon="juelich:logo"></iron-icon>
            <span>{{localize('login', 'name')}}</span>
          </button>
        </webvisual-button>
      </form>
    </div>
  </template>

  <script>
    Polymer({

      is: 'webvisual-login',

      behaviors: [
        WebvisualBehaviors.LocalizeBehavior
      ],

      properties: {

        loggedIn: {
          type: Boolean,
          notify: true
        },

        authUrl: {
          type: String,
          value: '/auth'
        }

      },

      observers: [
        '_onSignIn(visible)'
      ],

      /**
       * Let users sign-in without typing credentials
       * @param  {Boolean} unmediated Determines if user mediation is required.
       * @return {Promise} Resolves if credential info is available.
       */
      _autoSignIn: function(unmediated) {
        if (navigator.credentials) {
          // Actual Credential Management API call to get credential object
          return navigator.credentials.get({
            password: true,
            unmediated: unmediated
          }).then(function(cred) {
            // If credential object is available
            if (cred) {
              console.log('auto sign-in performed');

              switch (cred.type) {
                case 'password':
                  // Change form `id` name to `username`
                  cred.idName = 'username';
                  // Include CSRF token in the credential object
                  var csrf_token = new FormData();
                  csrf_token.append('csrf_token',
                    this.$.csrf_token.value);
                  // `.additionalData` accepts `FormData`
                  // You can include CSRF token etc.
                  cred.additionalData = csrf_token;
                  // Return Promise from `pwSignIn`
                  return this.pwSignIn(cred);
              }
            } else {
              console.log('auto sign-in not performed');

              // Resolve if credential object is not available
              return Promise.resolve();
            }
          }.bind(this));
        } else {
          // Resolve if Credential Management API is not available
          return Promise.resolve();
        }
      },

      /**
       * Authentication flow with our own server
       * @param  {String} provider Credential type string.
       * @param  {FormData} form FormData to POST to the server
       * @return {Promise} Resolves when successfully authenticated
       */
      _authenticateWithServer: function(url, form) {

        return fetch(url, {
          method: 'POST',
          // `credentials:'include'` is required to include cookies on `fetch`
          credentials: 'include',
          body: form
        }).then(function(res) {
          // Convert JSON string to an object
          if (res.status === 200) {
            return res.json();
          } else {
            return Promise.reject();
          }
        }).then(this.signedIn);
      },

      /**
       * When password sign-in button is pressed.
       * @return {void}
       */
      onPwSignIn: function(e) {
        e.preventDefault();

        var signinForm = e.target;

        // Polymer `iron-form` feature to validate the form
        if (!signinForm.validate()) return;

        if (navigator.credentials) {
          // Construct `FormData` object from actual `form`
          var cred = new PasswordCredential(signinForm);

          // Sign-In with our own server
          this.pwSignIn(cred)
            .then(function(profile) {
              this.loggedIn = true;

              // `profile` may involve user name returned by the server
              cred.username = profile.username;
              // Store credential information before posting
              navigator.credentials.store(cred);

              this.dispatchEvent(new CustomEvent('announce', {
                detail: this.localize ? this.localize('notification', 'loggedIn', true) :
                  'You are signed in'
              }), {
                bubbles: true
              });
            }.bind(this), function() {
              this.loggedIn = false;
              // message event to notice user that 'Authentication failed'.

              this.dispatchEvent(new CustomEvent('announce', {
                detail: this.localize ? this.localize('notification', 'loggedIn', false) :
                  'You are not signed in'
              }), {
                bubbles: true
              });
            }.bind(this));
        } else {
          this._authenticateWithServer(this.authUrl, new FormData(signinForm))
            .then(function() {
              this.loggedIn = true;

              this.dispatchEvent(new CustomEvent('announce', {
                detail: this.localize ? this.localize('notification', 'loggedIn', true) :
                  'You are signed in'
              }), {
                bubbles: true
              });
            }.bind(this), function() {
              this.loggedIn = false;

              this.dispatchEvent(new CustomEvent('announce', {
                detail: this.localize ? this.localize('notification', 'loggedIn', false) :
                  'You are not signed in'
              }), {
                bubbles: true
              });
            }.bind(this));
        }
      },

      /**
       * Let user sign-in using id/password
       * @param  {CredentialObject} cred FormData or CredentialObject
       * @return {Promise} Returns result of `_authenticateWithServer()`
       */
      pwSignIn: function(cred) {
        // POST-ing credential object will be converted to FormData object
        return fetch('/auth', {
          method: 'POST',
          // Include the credential object as `credentials`
          credentials: cred
        }).then(function(res) {
          // Convert JSON string to an object
          if (res.status === 200) {
            return res.json();
          } else {
            return Promise.reject();
          }
        }).then(this.signedIn);
      },

      /**
       * User is signed in. Fill user info.
       * @param  {Object} profile Profile information object
       * @return {Promise} Resolves when authentication succeeded.
       */
      signedIn: function(profile) {
        if (profile && profile.username) {
          this.userProfile = {
            username: profile.username
          };
          return Promise.resolve(profile);
        } else {
          return Promise.reject();
        }
      },

      /**
       * Invoked when 'Sign-In' button is pressed, perform auto-sign-in and
       * open dialog if it fails.
       * @return {void}
       */
      _onSignIn: function() {
        // Try auto sign-in before opening the dialog
        this._autoSignIn(false)
          .then(function(profile) {
            // When auto sign-in didn't resolve with a profile
            // it's failed to get credential information.
            // Open the form so the user can enter id/password
            // or select federated login manually
            if (!profile) {
              // this.$.dialog.open();
              this.focus();
            }
          }, function() {
            // this.$.dialog.open();
            this.focus();
            // When rejected, authentication was performed but failed.
            this.dispatchEvent(new CustomEvent('announce', {
              detail: this.localize ? this.localize('notification', 'loggedIn', false) :
                'You are not signed in'
            }), {
              bubbles: true
            });
          });
      }


    });
  </script>

</dom-module>
